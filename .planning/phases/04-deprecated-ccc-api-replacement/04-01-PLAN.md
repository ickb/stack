---
phase: 04-deprecated-ccc-api-replacement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/order/src/order.ts
  - packages/sdk/src/constants.ts
autonomous: true
requirements:
  - SMTX-05

must_haves:
  truths:
    - "OrderManager constructor accepts udtScript: ccc.Script as its third parameter"
    - "OrderManager methods do not add UDT cellDeps to transactions"
    - "@ickb/order does not import UdtHandler from @ickb/utils"
    - "SDK constructs OrderManager with ickbUdt.script (a ccc.Script), not the full IckbUdtManager instance"
    - "pnpm check:full passes with zero errors"
  artifacts:
    - path: "packages/order/src/order.ts"
      provides: "OrderManager with udtScript: ccc.Script parameter, no UDT cellDeps"
      contains: "public readonly udtScript: ccc.Script"
    - path: "packages/sdk/src/constants.ts"
      provides: "SDK caller passing ickbUdt.script to OrderManager"
      contains: "ickbUdt.script"
  key_links:
    - from: "packages/sdk/src/constants.ts"
      to: "packages/order/src/order.ts"
      via: "OrderManager constructor call"
      pattern: "new OrderManager\\(.*ickbUdt\\.script\\)"
    - from: "packages/order/src/order.ts"
      to: "@ckb-ccc/core"
      via: "ccc.Script type for udtScript"
      pattern: "udtScript: ccc\\.Script"
---

<objective>
Replace UdtHandler dependency in @ickb/order with plain ccc.Script; remove UDT cellDeps management from OrderManager; update SDK caller site.

Purpose: OrderManager only needs the UDT type script for cell identification (type script matching, output cell construction). The full UdtHandler interface with balance/completion methods is unnecessary coupling. UDT cellDeps management is moved to the caller/CCC Udt during balance completion, aligning with CCC's completion pipeline pattern.

Output: Modified order.ts and constants.ts; verified @ickb/dao is already clean; verified Phase 3 decision doc already corrected.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deprecated-ccc-api-replacement/04-CONTEXT.md
@.planning/phases/04-deprecated-ccc-api-replacement/04-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From packages/order/src/order.ts (BEFORE -- current state):
```typescript
import { type UdtHandler } from "@ickb/utils";

export class OrderManager implements ScriptDeps {
  constructor(
    public readonly script: ccc.Script,
    public readonly cellDeps: ccc.CellDep[],
    public readonly udtHandler: UdtHandler,   // CHANGE THIS
  ) {}
}
```

9 udtHandler references to replace (verified line-by-line):
- Line 7: `type UdtHandler,` in import -> REMOVE from import
- Line 22: JSDoc `@param udtHandler` -> `@param udtScript`
- Line 27: constructor `public readonly udtHandler: UdtHandler` -> `public readonly udtScript: ccc.Script`
- Line 42: `this.udtHandler.script` -> `this.udtScript` (isOrder)
- Line 190: `tx.addCellDeps(this.udtHandler.cellDeps)` -> DELETE LINE (mint)
- Line 196: `this.udtHandler.script` -> `this.udtScript` (mint output)
- Line 229: `tx.addCellDeps(this.udtHandler.cellDeps)` -> DELETE LINE (addMatch)
- Line 236: `this.udtHandler.script` -> `this.udtScript` (addMatch output)
- Line 519: `tx.addCellDeps(this.udtHandler.cellDeps)` -> DELETE LINE (melt)
- Line 635: `this.udtHandler.script` -> `this.udtScript` (findSimpleOrders)

From packages/sdk/src/constants.ts line 78:
```typescript
const order = new OrderManager(d.order.script, d.order.cellDeps, ickbUdt);
// ickbUdt is IckbUdtManager which implements UdtHandler
// Change to: ickbUdt.script
```

From @ickb/utils (UdtHandler interface -- reference only, NOT modified):
```typescript
export interface UdtHandler extends ScriptDeps {
  script: ccc.Script;
  cellDeps: ccc.CellDep[];
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace UdtHandler with udtScript in OrderManager and update SDK caller</name>
  <files>packages/order/src/order.ts, packages/sdk/src/constants.ts</files>
  <action>
In `packages/order/src/order.ts`:

1. Remove `type UdtHandler,` from the `@ickb/utils` import statement (line 7). Keep all other imports (`BufferedGenerator`, `defaultFindCellsLimit`, `ExchangeRatio`, `ScriptDeps`, `ValueComponents`).

2. Update JSDoc on line 22: change `@param udtHandler - The handler for UDT (User Defined Token).` to `@param udtScript - The UDT (User Defined Token) type script.`

3. Update constructor parameter on line 27: change `public readonly udtHandler: UdtHandler,` to `public readonly udtScript: ccc.Script,`

4. In `isOrder()` (line 42): change `this.udtHandler.script` to `this.udtScript`

5. In `mint()`:
   - DELETE line 190: `tx.addCellDeps(this.udtHandler.cellDeps);`
   - Change line 196: `type: this.udtHandler.script,` to `type: this.udtScript,`
   - Add JSDoc `@remarks` to mint()'s existing JSDoc block (after the existing content, before `@param`): `@remarks Caller must ensure UDT cellDeps are added to the transaction (e.g., via CCC Udt balance completion).`

6. In `addMatch()`:
   - DELETE line 229: `tx.addCellDeps(this.udtHandler.cellDeps);`
   - Change line 236: `type: this.udtHandler.script,` to `type: this.udtScript,`
   - Add JSDoc `@remarks` to addMatch()'s existing JSDoc block: `@remarks Caller must ensure UDT cellDeps are added to the transaction (e.g., via CCC Udt balance completion).`

7. In `melt()`:
   - DELETE line 519: `tx.addCellDeps(this.udtHandler.cellDeps);`
   - Add JSDoc `@remarks` to melt()'s existing JSDoc block: `@remarks Caller must ensure UDT cellDeps are added to the transaction (e.g., via CCC Udt balance completion).`

8. In `findSimpleOrders()` (line 635): change `script: this.udtHandler.script,` to `script: this.udtScript,`

In `packages/sdk/src/constants.ts`:

9. Change line 78 from:
   `const order = new OrderManager(d.order.script, d.order.cellDeps, ickbUdt);`
   to:
   `const order = new OrderManager(d.order.script, d.order.cellDeps, ickbUdt.script);`

Apply changes top-to-bottom within each file to avoid line number drift issues.
  </action>
  <verify>
    <automated>cd /workspaces/stack && pnpm check:full</automated>
  </verify>
  <done>
    - OrderManager constructor parameter is `udtScript: ccc.Script` (not `udtHandler: UdtHandler`)
    - All 4 `.script` accesses simplified from `this.udtHandler.script` to `this.udtScript`
    - All 3 `tx.addCellDeps(this.udtHandler.cellDeps)` lines deleted from mint/addMatch/melt
    - `UdtHandler` no longer appears in @ickb/order imports
    - JSDoc @remarks added to mint(), addMatch(), melt() about caller cellDeps responsibility
    - SDK passes `ickbUdt.script` to OrderManager constructor
    - `pnpm check:full` passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify @ickb/dao and Phase 3 decision doc are already clean</name>
  <files></files>
  <action>
Verify (grep-based, no changes expected):

1. Confirm @ickb/dao has no UdtHandler references:
   `grep -r "UdtHandler\|udtHandler" packages/dao/src/` should return no matches.

2. Confirm @ickb/dao has no deprecated CCC API calls:
   `grep -r "udtBalanceFrom\|getInputsUdtBalance\|getOutputsUdtBalance\|completeInputsByUdt" packages/dao/src/` should return no matches.

3. Confirm Phase 3 decision doc `03-DECISION.md` lines 369-388 already contain the correct Phase 4 guidance (updated 2026-02-26 in commit c7ba503):
   - States DaoManager never had UdtHandler
   - States OrderManager gets `udtScript: ccc.Script`
   - States UDT cellDeps removed from OrderManager
   If content is correct, no changes needed (verification only).

4. Confirm @ickb/order no longer imports UdtHandler after Task 1:
   `grep -r "UdtHandler" packages/order/src/` should return no matches.

All four checks must pass. If any check fails, investigate and fix. These are expected to all pass (dao was always clean, decision doc was pre-corrected, order was cleaned in Task 1).
  </action>
  <verify>
    <automated>cd /workspaces/stack && grep -r "UdtHandler\|udtHandler" packages/dao/src/ packages/order/src/ ; echo "exit: $?"</automated>
  </verify>
  <done>
    - @ickb/dao confirmed clean: no UdtHandler references, no deprecated CCC API calls
    - Phase 3 decision doc verified correct (no changes needed)
    - @ickb/order confirmed clean: no remaining UdtHandler references after Task 1
  </done>
</task>

</tasks>

<verification>
1. `pnpm check:full` passes -- all 5 library packages compile with zero type errors
2. `grep -r "UdtHandler\|udtHandler" packages/order/src/ packages/dao/src/` returns no matches
3. `grep -r "udtBalanceFrom\|getInputsUdtBalance\|getOutputsUdtBalance\|completeInputsByUdt" packages/dao/src/ packages/order/src/` returns no matches
4. `grep "udtScript: ccc.Script" packages/order/src/order.ts` confirms new parameter
5. `grep "ickbUdt.script" packages/sdk/src/constants.ts` confirms SDK caller update
</verification>

<success_criteria>
- OrderManager uses `udtScript: ccc.Script` instead of `udtHandler: UdtHandler`
- No UDT cellDeps added by OrderManager (3 lines deleted)
- @ickb/order has zero imports of UdtHandler
- SDK constructs OrderManager with `ickbUdt.script`
- @ickb/dao verified clean (no changes needed)
- Phase 3 decision doc verified correct (no changes needed)
- `pnpm check:full` passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-deprecated-ccc-api-replacement/04-01-SUMMARY.md`
</output>
