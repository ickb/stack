---
phase: 02-ccc-utility-adoption
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/utils/src/utils.ts
  - packages/order/src/entities.ts
  - packages/sdk/src/codec.ts
  - packages/order/src/order.ts
  - packages/sdk/src/sdk.ts
  - apps/faucet/src/main.ts
autonomous: true
requirements:
  - DEDUP-01
  - DEDUP-02
  - DEDUP-03
  - DEDUP-04
  - DEDUP-05

must_haves:
  truths:
    - "All call sites using local max()/min() now use Number(ccc.numMax())/Number(ccc.numMin()) and the local implementations are deleted"
    - "The single gcd() call site uses ccc.gcd() and the local implementation is deleted"
    - "Local isHex() and hexFrom() are deleted from @ickb/utils"
    - "All hexFrom() call sites use entity.toHex() for Entity args and ccc.hexFrom() for BytesLike args"
    - "iCKB-unique utilities (binarySearch, asyncBinarySearch, shuffle, unique, collect, BufferedGenerator, MinHeap, sum) remain in @ickb/utils unchanged in signature"
    - "unique() internal implementation updated from hexFrom(i) to i.toHex()"
    - "pnpm check:full passes with zero errors"
  artifacts:
    - path: "packages/utils/src/utils.ts"
      provides: "Utility module with local max/min/gcd/hexFrom/isHex deleted, unique() updated"
      contains: "i.toHex()"
    - path: "packages/order/src/entities.ts"
      provides: "Order entities with CCC utility calls"
      contains: "ccc.gcd"
    - path: "packages/sdk/src/codec.ts"
      provides: "SDK codec with CCC numMax"
      contains: "ccc.numMax"
  key_links:
    - from: "packages/order/src/entities.ts"
      to: "@ckb-ccc/core"
      via: "ccc.gcd() and Number(ccc.numMax()) calls"
      pattern: "ccc\\.gcd|ccc\\.numMax"
    - from: "packages/sdk/src/codec.ts"
      to: "@ckb-ccc/core"
      via: "Number(ccc.numMax()) call"
      pattern: "ccc\\.numMax"
    - from: "packages/utils/src/utils.ts"
      to: "@ckb-ccc/core"
      via: "unique() uses entity.toHex() instead of deleted hexFrom()"
      pattern: "i\\.toHex\\(\\)"
---

<objective>
Replace five local utility functions (max, min, gcd, hexFrom, isHex) in @ickb/utils with their CCC equivalents at all call sites, update the unique() internal implementation, delete the local function definitions, and verify iCKB-unique utilities remain intact.

Purpose: Eliminate duplicated functionality with CCC core -- local copies diverge over time and create maintenance burden.
Output: All packages and apps compile cleanly with CCC utility calls instead of local wrappers.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ccc-utility-adoption/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace all external call sites with CCC equivalents</name>
  <files>
    packages/order/src/entities.ts
    packages/sdk/src/codec.ts
    packages/order/src/order.ts
    packages/sdk/src/sdk.ts
    apps/faucet/src/main.ts
  </files>
  <action>
Replace every external call site of the five local utility functions with CCC equivalents. The exact replacements are:

**max() -- 2 call sites (DEDUP-01):**
1. `packages/order/src/entities.ts` line ~172: `max(aScale.toString(2).length, bScale.toString(2).length)` becomes `Number(ccc.numMax(aScale.toString(2).length, bScale.toString(2).length))`. Remove `max` from the `@ickb/utils` import.
2. `packages/sdk/src/codec.ts` line ~80: `max(1, ...bins)` becomes `Number(ccc.numMax(1, ...bins))`. Remove `max` from the `@ickb/utils` import (this may make the import empty or removable).

**gcd() -- 1 call site (DEDUP-02):**
1. `packages/order/src/entities.ts` line ~167: `gcd(aScale, bScale)` becomes `ccc.gcd(aScale, bScale)`. Remove `gcd` from the `@ickb/utils` import. Note: CCC's gcd returns `Num` (bigint), same type as current usage -- direct drop-in.

**hexFrom() -- 5 external call sites (DEDUP-04):**
1. `packages/sdk/src/sdk.ts` line ~393: `hexFrom(cell.cellOutput.lock)` becomes `cell.cellOutput.lock.toHex()`. Remove `hexFrom` from the `@ickb/utils` import.
2. `packages/sdk/src/sdk.ts` line ~423: `hexFrom(wr.owner.cell.cellOutput.lock)` becomes `wr.owner.cell.cellOutput.lock.toHex()`. (Same import fix as above.)
3. `packages/order/src/order.ts` line ~560: `hexFrom(master.cell.outPoint)` becomes `master.cell.outPoint.toHex()`. Remove `hexFrom` from the `@ickb/utils` import.
4. `packages/order/src/order.ts` line ~572: `hexFrom(master)` becomes `master.toHex()`. (Same import fix as above.)
5. `apps/faucet/src/main.ts` line ~20: `hexFrom(getRandomValues(new Uint8Array(32)))` becomes `ccc.hexFrom(getRandomValues(new Uint8Array(32)))`. Remove `hexFrom` from the `@ickb/utils` import. Add `import { ccc } from "@ckb-ccc/core";` if not already present.

After all replacements, clean up imports: remove `max`, `min`, `gcd`, `hexFrom`, `isHex` from all `@ickb/utils` import statements. If an import statement becomes empty, delete it entirely. If it still has other symbols (e.g., `CheckedInt32LE`, `unique`, `sum`), keep only those.

IMPORTANT: Use `import type` for type-only imports per `verbatimModuleSyntax`. All functions must have explicit return type annotations per ESLint rules.
  </action>
  <verify>
Run `pnpm -r --filter './packages/**' --filter './apps/faucet' exec tsc --noEmit` to verify all modified packages compile. No import errors for removed symbols.
  </verify>
  <done>
All 8 external call sites (2 max, 1 gcd, 5 hexFrom) replaced with CCC equivalents. Zero references to local max/min/gcd/hexFrom/isHex remain in any file outside packages/utils/src/utils.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update unique() internals, delete local functions, generate changeset, and verify</name>
  <files>
    packages/utils/src/utils.ts
  </files>
  <action>
**Step 1: Update `unique()` internal call (DEDUP-05 preservation):**
In `packages/utils/src/utils.ts`, inside the `unique()` function (line ~349), change:
```typescript
const key = hexFrom(i);
```
to:
```typescript
const key = i.toHex();
```
The function signature, JSDoc, and external behavior remain identical -- only the internal implementation detail changes. Update the JSDoc to mention `toHex()` instead of `hexFrom` in the description ("based on their hex representation" or similar).

**Step 2: Delete local function definitions (DEDUP-01, DEDUP-02, DEDUP-03, DEDUP-04):**
Delete these functions and their JSDoc from `packages/utils/src/utils.ts`:
- `max<T>(res: T, ...rest: T[]): T` (starts at line ~227, ~20 lines including JSDoc)
- `min<T>(res: T, ...rest: T[]): T` (starts at line ~250, ~20 lines including JSDoc)
- `gcd(res: bigint, ...rest: bigint[]): bigint` (starts at line ~314, ~18 lines including JSDoc)
- `hexFrom(v: bigint | ccc.Entity | ccc.BytesLike): ccc.Hex` (starts at line ~357, ~38 lines including JSDoc)
- `isHex(s: string): s is ccc.Hex` (starts at line ~396, ~30 lines including JSDoc)

Preserve ALL other functions in utils.ts: `binarySearch`, `asyncBinarySearch`, `shuffle`, `unique`, `collect`, `BufferedGenerator`, `MinHeap`, `sum`, and any others. These are iCKB-unique utilities with no CCC equivalents.

**Step 3: Generate changeset:**
Run `pnpm changeset` non-interactively or create the changeset file manually in `.changeset/`. The changeset should:
- Mark `@ickb/utils` as a minor change (removing public exports is breaking but project uses Epoch SemVer)
- Summary: "Remove local max, min, gcd, hexFrom, isHex utility functions -- replaced by CCC equivalents (ccc.numMax, ccc.numMin, ccc.gcd, ccc.hexFrom, ccc.isHex, entity.toHex())"

**Step 4: Full verification:**
Run `pnpm check:full` to verify the entire build pipeline passes. This wipes derived state and regenerates from scratch, confirming no broken references.

IMPORTANT: Do NOT delete `sum()`. It has no CCC equivalent and must be preserved. Same for all utilities listed in DEDUP-05.
  </action>
  <verify>
1. `grep -rn "export function max\|export function min\|export function gcd\|export function hexFrom\|export function isHex" packages/utils/src/utils.ts` returns zero matches (all five deleted).
2. `grep -n "export function unique\|export function sum\|export function binarySearch\|export function shuffle\|export function collect\|export class BufferedGenerator\|export class MinHeap" packages/utils/src/utils.ts` returns 7+ matches (all preserved).
3. `grep -n "i.toHex()" packages/utils/src/utils.ts` returns a match inside `unique()`.
4. `pnpm check:full` passes with zero errors.
5. A changeset file exists in `.changeset/` documenting the removal.
  </verify>
  <done>
Local max, min, gcd, hexFrom, isHex are deleted from @ickb/utils. unique() uses entity.toHex() internally. All iCKB-unique utilities preserved. Changeset generated. pnpm check:full passes.
  </done>
</task>

</tasks>

<verification>
1. No references to local `max`, `min`, `gcd`, `hexFrom`, or `isHex` exist as imports from `@ickb/utils` in any file across the repo
2. All call sites use CCC equivalents: `ccc.numMax`, `ccc.numMin`, `ccc.gcd`, `ccc.hexFrom`, `entity.toHex()`, `ccc.numToHex`, `ccc.isHex`
3. The five function definitions are deleted from `packages/utils/src/utils.ts`
4. `unique()` in `packages/utils/src/utils.ts` uses `i.toHex()` internally
5. All iCKB-unique utilities remain exported from `@ickb/utils`
6. `pnpm check:full` passes
7. A changeset entry exists for the breaking API change
</verification>

<success_criteria>
- Zero type errors across all 5 library packages and all apps
- Zero imports of max/min/gcd/hexFrom/isHex from @ickb/utils anywhere in the codebase
- All 8 external call sites replaced with CCC equivalents per the research inventory
- iCKB-unique utilities compile and export correctly
- Changeset generated documenting the removal
</success_criteria>

<output>
After completion, create `.planning/phases/02-ccc-utility-adoption/02-01-SUMMARY.md`
</output>
