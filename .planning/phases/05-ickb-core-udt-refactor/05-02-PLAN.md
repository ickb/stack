---
phase: 05-ickb-core-udt-refactor
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - packages/utils/src/udt.ts
  - packages/utils/src/index.ts
  - packages/sdk/src/constants.ts
autonomous: true
requirements:
  - SMTX-05
  - SMTX-07
  - SMTX-10
  - UDT-04

must_haves:
  truths:
    - "UdtHandler interface, UdtManager class, ErrorTransactionInsufficientCoin, UdtCell, findUdts, addUdts, isUdtSymbol are deleted from @ickb/utils"
    - "packages/utils/src/udt.ts file no longer exists"
    - "@ickb/utils no longer exports any UDT-related types"
    - "SDK constructs IckbUdt instead of IckbUdtManager"
    - "SDK passes ickbUdt.script to OrderManager"
    - "LogicManager and OwnedOwnerManager constructed without ickbUdt argument"
    - "pnpm check:full passes with zero errors"
    - "SDK audited for ErrorTransactionInsufficientCoin catch blocks -- zero found, no migration required; ErrorUdtInsufficientCoin is CCC's responsibility and surfaces to callers unchanged"
  artifacts:
    - path: "packages/utils/src/index.ts"
      provides: "Barrel export without udt.ts"
    - path: "packages/sdk/src/constants.ts"
      provides: "getConfig() constructing IckbUdt with code OutPoints"
      contains: "new IckbUdt"
  key_links:
    - from: "packages/sdk/src/constants.ts"
      to: "packages/core/src/udt.ts"
      via: "import { IckbUdt } and constructor call"
      pattern: "new IckbUdt\\("
    - from: "packages/sdk/src/constants.ts"
      to: "packages/core/src/udt.ts"
      via: "IckbUdt.typeScriptFrom for script computation"
      pattern: "IckbUdt\\.typeScriptFrom"
---

<objective>
Delete UDT infrastructure from @ickb/utils (UdtHandler, UdtManager, ErrorTransactionInsufficientCoin, UdtCell, findUdts, addUdts, isUdtSymbol). Update SDK to construct IckbUdt with individual code OutPoints instead of IckbUdtManager with dep group. Verify the full stack compiles.

Purpose: With IckbUdt replacing IckbUdtManager (Plan 05-01) and all managers cleaned of udtHandler references, the entire UDT infrastructure in @ickb/utils has zero consumers. Deleting it eliminates ~400 lines of duplicated code. The SDK wiring completes the refactor by constructing IckbUdt with the CCC-aligned code OutPoint pattern.

Output: Deleted utils/src/udt.ts, updated utils/src/index.ts, rewritten SDK constants.ts. Full stack compiles via pnpm check:full.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ickb-core-udt-refactor/05-CONTEXT.md
@.planning/phases/05-ickb-core-udt-refactor/05-RESEARCH.md
@.planning/phases/05-ickb-core-udt-refactor/05-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. From Plan 05-01 output + codebase. -->

From packages/core/src/udt.ts (AFTER Plan 05-01 -- new IckbUdt class):
```typescript
import { udt } from "@ckb-ccc/udt";

export class IckbUdt extends udt.Udt {
  constructor(
    code: ccc.OutPointLike,         // xUDT code cell OutPoint
    script: ccc.ScriptLike,          // iCKB UDT type script
    logicCode: ccc.OutPointLike,     // iCKB Logic code cell OutPoint
    logicScript: ccc.ScriptLike,     // iCKB Logic script
    daoManager: DaoManager,          // DAO manager for deposit detection
  );
  static typeScriptFrom(udt: ccc.Script, ickbLogic: ccc.Script): ccc.Script;
  override async infoFrom(client, cells, acc?): Promise<udt.UdtInfo>;
  override addCellDeps(txLike): ccc.Transaction;
}
```

From packages/core/src/logic.ts (AFTER Plan 05-01 -- no udtHandler):
```typescript
export class LogicManager implements ScriptDeps {
  constructor(
    public readonly script: ccc.Script,
    public readonly cellDeps: ccc.CellDep[],
    public readonly daoManager: DaoManager,
    // udtHandler REMOVED
  ) {}
}
```

From packages/core/src/owned_owner.ts (AFTER Plan 05-01 -- no udtHandler):
```typescript
export class OwnedOwnerManager implements ScriptDeps {
  constructor(
    public readonly script: ccc.Script,
    public readonly cellDeps: ccc.CellDep[],
    public readonly daoManager: DaoManager,
    // udtHandler REMOVED
  ) {}
}
```

From packages/sdk/src/constants.ts (BEFORE -- current state to modify):
```typescript
import { IckbUdtManager, LogicManager, OwnedOwnerManager } from "@ickb/core";

export function getConfig(d, bots): {
  managers: {
    dao: DaoManager;
    ickbUdt: IckbUdtManager;  // CHANGE to IckbUdt
    logic: LogicManager;
    ownedOwner: OwnedOwnerManager;
    order: OrderManager;
  };
  bots: ccc.Script[];
}

// Current construction:
const ickbUdt = new IckbUdtManager(
  d.udt.script,      // script
  d.udt.cellDeps,     // cellDeps (dep group)
  d.logic.script,     // logicScript
  dao,                 // daoManager
);
const logic = new LogicManager(d.logic.script, d.logic.cellDeps, dao, ickbUdt);
const ownedOwner = new OwnedOwnerManager(d.ownedOwner.script, d.ownedOwner.cellDeps, dao, ickbUdt);
```

Code cell OutPoints for IckbUdt construction (from forks/contracts/scripts/deployment/):
```
Mainnet xUDT code:    txHash 0xc07844ce21b38e4b071dd0e1ee3b0e27afd8d7532491327f39b786343f558ab7, index 0x0
Mainnet Logic code:   txHash 0xd7309191381f5a8a2904b8a79958a9be2752dbba6871fa193dab6aeb29dc8f44, index 0x0
Testnet xUDT code:    txHash 0xbf6fb538763efec2a70a6a3dcb7242787087e1030c4e7d86585bc63a9d337f5f, index 0x0
Testnet Logic code:   txHash 0x9ac989b3355764f76cdce02c69dedb819fdfbcbda49a7db1a2c9facdfdb9a7fe, index 0x0
```

ScriptDeps interface (PRESERVED in @ickb/utils -- NOT deleted):
```typescript
// From packages/utils/src/utils.ts
export interface ScriptDeps {
  script: ccc.Script;
  cellDeps: ccc.CellDep[];
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete utils/src/udt.ts and update barrel export</name>
  <files>packages/utils/src/udt.ts, packages/utils/src/index.ts</files>
  <action>
**Step 1: Delete `packages/utils/src/udt.ts`**

Delete the entire file. This removes:
- `UdtHandler` interface (zero consumers after Plan 05-01)
- `ErrorTransactionInsufficientCoin` class (zero catch blocks across entire codebase)
- `UdtManager` class (replaced by `IckbUdt extends udt.Udt`)
- `UdtCell` interface (internal to `UdtManager`)
- `findUdts` method (internal to `UdtManager`)
- `addUdts` method (internal to `UdtManager`)
- `isUdtSymbol` constant (internal to `UdtManager`)

~406 lines deleted.

**Step 2: Update `packages/utils/src/index.ts`**

Remove the line `export * from "./udt.js";`. The file should become:
```typescript
export * from "./codec.js";
export * from "./heap.js";
export * from "./utils.js";
```

**IMPORTANT: `ScriptDeps` interface is NOT in udt.ts.** It lives in `packages/utils/src/utils.ts` and has 6+ consumers remaining (DaoManager, LogicManager, OwnedOwnerManager, OrderManager, getConfig). It is preserved by this change. `ExchangeRatio` is also in `utils.ts`, not `udt.ts`. `ValueComponents` is also in `utils.ts`. All of these survive.
  </action>
  <verify>
    <automated>cd /workspaces/stack && ! test -f packages/utils/src/udt.ts && ! grep -q "udt.js" packages/utils/src/index.ts && grep -q "ScriptDeps" packages/utils/src/utils.ts && echo "PASS"</automated>
  </verify>
  <done>
    - packages/utils/src/udt.ts deleted (~406 lines removed)
    - export * from "./udt.js" removed from index.ts
    - UdtHandler, UdtManager, ErrorTransactionInsufficientCoin, UdtCell, findUdts, addUdts, isUdtSymbol all gone
    - ScriptDeps, ExchangeRatio, ValueComponents preserved in utils.ts (unaffected)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SDK getConfig to construct IckbUdt with code OutPoints and verify full stack</name>
  <files>packages/sdk/src/constants.ts</files>
  <action>
**Step 1: Update imports in `packages/sdk/src/constants.ts`**

Change the `@ickb/core` import from:
```typescript
import { IckbUdtManager, LogicManager, OwnedOwnerManager } from "@ickb/core";
```
to:
```typescript
import { IckbUdt, LogicManager, OwnedOwnerManager } from "@ickb/core";
```

**Step 2: Add code cell OutPoint constants**

Add these constants AFTER the existing script constants (after `ORDER` on line 154) and BEFORE the dep group constants (`MAINNET_DEP_GROUP` on line 159):

```typescript
/**
 * Mainnet xUDT code cell OutPoint.
 * Source: forks/contracts/scripts/deployment/mainnet/deployment.toml
 */
const MAINNET_XUDT_CODE = {
  txHash:
    "0xc07844ce21b38e4b071dd0e1ee3b0e27afd8d7532491327f39b786343f558ab7",
  index: "0x0",
};

/**
 * Mainnet iCKB Logic code cell OutPoint.
 * Source: forks/contracts/scripts/deployment/mainnet/deployment.toml
 */
const MAINNET_LOGIC_CODE = {
  txHash:
    "0xd7309191381f5a8a2904b8a79958a9be2752dbba6871fa193dab6aeb29dc8f44",
  index: "0x0",
};

/**
 * Testnet xUDT code cell OutPoint.
 * Source: forks/contracts/scripts/deployment/testnet/deployment.toml
 */
const TESTNET_XUDT_CODE = {
  txHash:
    "0xbf6fb538763efec2a70a6a3dcb7242787087e1030c4e7d86585bc63a9d337f5f",
  index: "0x0",
};

/**
 * Testnet iCKB Logic code cell OutPoint.
 * Source: forks/contracts/scripts/deployment/testnet/deployment.toml
 */
const TESTNET_LOGIC_CODE = {
  txHash:
    "0x9ac989b3355764f76cdce02c69dedb819fdfbcbda49a7db1a2c9facdfdb9a7fe",
  index: "0x0",
};
```

**Step 3: Update return type annotation**

Change the return type from `ickbUdt: IckbUdtManager` to `ickbUdt: IckbUdt` (line 37).

**Step 4: Rewrite IckbUdt construction in getConfig()**

Replace the existing IckbUdtManager construction (lines 60-65):
```typescript
const ickbUdt = new IckbUdtManager(
  d.udt.script,
  d.udt.cellDeps,
  d.logic.script,
  dao,
);
```

For mainnet/testnet paths, the construction needs code OutPoints. The current flow creates `d` from `from(UDT, depGroup)` etc. which gives `ScriptDeps` with `script` and `cellDeps`. The `IckbUdt` constructor needs `code: OutPointLike` (xUDT code OutPoint) and `logicCode: OutPointLike` (Logic code OutPoint) which are NOT in `ScriptDeps`.

For the mainnet/testnet case: extract code OutPoints based on the network string BEFORE it gets reassigned. The cleanest approach:

Replace the entire IckbUdt construction block with:
```typescript
const isMainnet = typeof d !== "string" ? undefined : d === "mainnet";
// ... after d is reassigned to ScriptDeps ...
const ickbUdt = new IckbUdt(
  isMainnet !== undefined
    ? (isMainnet ? MAINNET_XUDT_CODE : TESTNET_XUDT_CODE)
    : d.udt.cellDeps[0]?.outPoint ?? { txHash: "0x", index: "0x0" },
  IckbUdt.typeScriptFrom(
    ccc.Script.from(d.udt.script),
    ccc.Script.from(d.logic.script),
  ),
  isMainnet !== undefined
    ? (isMainnet ? MAINNET_LOGIC_CODE : TESTNET_LOGIC_CODE)
    : d.logic.cellDeps[0]?.outPoint ?? { txHash: "0x", index: "0x0" },
  d.logic.script,
  dao,
);
```

Wait -- the existing code reassigns `d` inside the `if` block. For devnet, `d` is already a config object. Let me trace the flow more carefully.

Actually, the cleanest approach: capture the network string before `d` gets reassigned.

Add `const isMainnet = ...` BEFORE the `if (d === "mainnet" || d === "testnet")` block:

```typescript
const network = typeof d === "string" ? d : undefined;
```

Then the construction becomes:
```typescript
const ickbUdt = new IckbUdt(
  network ? (network === "mainnet" ? MAINNET_XUDT_CODE : TESTNET_XUDT_CODE)
    : d.udt.cellDeps[0]?.outPoint ?? { txHash: "0x", index: "0x0" },
  IckbUdt.typeScriptFrom(
    ccc.Script.from(d.udt.script),
    ccc.Script.from(d.logic.script),
  ),
  network ? (network === "mainnet" ? MAINNET_LOGIC_CODE : TESTNET_LOGIC_CODE)
    : d.logic.cellDeps[0]?.outPoint ?? { txHash: "0x", index: "0x0" },
  d.logic.script,
  dao,
);
```

Note: For devnet, the OutPoints are derived from the first cellDep's outPoint (best available from the ScriptDeps interface). The devnet config shape remains unchanged -- this is a pragmatic fallback. Document this with a comment.

Alternative (simpler, per Claude's discretion): Since the devnet path is secondary and code OutPoints are only used by `addCellDeps`, devnet users can also use their dep group OutPoints as code OutPoints if their deps happen to be `depType: "code"` (which they are in local dev). Use `d.udt.cellDeps[0]?.outPoint` with a fallback.

**Step 5: Update LogicManager and OwnedOwnerManager construction**

Remove the `ickbUdt` argument from LogicManager and OwnedOwnerManager constructors:

Change:
```typescript
const logic = new LogicManager(
  d.logic.script,
  d.logic.cellDeps,
  dao,
  ickbUdt,
);
const ownedOwner = new OwnedOwnerManager(
  d.ownedOwner.script,
  d.ownedOwner.cellDeps,
  dao,
  ickbUdt,
);
```

To:
```typescript
const logic = new LogicManager(d.logic.script, d.logic.cellDeps, dao);
const ownedOwner = new OwnedOwnerManager(
  d.ownedOwner.script,
  d.ownedOwner.cellDeps,
  dao,
);
```

The OrderManager line already passes `ickbUdt.script` (from Phase 4).

**Step 6: Audit SDK and apps for ErrorTransactionInsufficientCoin catch blocks**

Run: `grep -r "ErrorTransactionInsufficientCoin" packages/sdk/ apps/` and confirm zero catch blocks exist. RESEARCH.md already found zero catch blocks across the entire codebase (the error was only thrown, never caught). Document this finding: `ErrorUdtInsufficientCoin` is CCC's responsibility -- it surfaces to callers unchanged from `completeInputsByBalance`. No SDK-side migration of catch blocks is needed.

If any catch blocks ARE found (unexpected), replace `ErrorTransactionInsufficientCoin` with `ErrorUdtInsufficientCoin` from `@ckb-ccc/udt` and update the import.

**Step 7: Run `pnpm check:full`**

This validates the entire stack compiles: all 5 library packages with strict TypeScript settings. This is the final gate for Phase 5.

If `pnpm check:full` fails, investigate and fix the errors. Common issues:
- Missing catalog entry for `@ckb-ccc/udt` (should be added in Plan 05-01)
- Type mismatch on `IckbUdt` constructor parameters
- ScriptDeps import breakage (should not happen -- ScriptDeps is in utils.ts, not udt.ts)
  </action>
  <verify>
    <automated>cd /workspaces/stack && pnpm check:full</automated>
  </verify>
  <done>
    - SDK imports IckbUdt (not IckbUdtManager) from @ickb/core
    - getConfig() return type uses IckbUdt (not IckbUdtManager)
    - IckbUdt constructed with code OutPoints (MAINNET_XUDT_CODE, MAINNET_LOGIC_CODE / testnet equivalents)
    - IckbUdt.typeScriptFrom used to compute type script (not hardcoded or from ScriptDeps)
    - LogicManager constructed without ickbUdt argument (3 params)
    - OwnedOwnerManager constructed without ickbUdt argument (3 params)
    - Code OutPoint constants added for both mainnet and testnet
    - Devnet path uses cellDeps[0].outPoint as fallback for code OutPoints
    - SDK and apps audited for ErrorTransactionInsufficientCoin catch blocks -- zero found, no migration required
    - pnpm check:full passes with zero errors across all 5 library packages
  </done>
</task>

</tasks>

<verification>
1. `pnpm check:full` passes -- all 5 library packages compile with zero type errors
2. `! test -f packages/utils/src/udt.ts` -- udt.ts deleted from utils
3. `! grep -q "udt.js" packages/utils/src/index.ts` -- barrel export removed
4. `grep -r "UdtHandler\|UdtManager\|UdtCell\|findUdts\|addUdts\|isUdtSymbol\|ErrorTransactionInsufficientCoin\|IckbUdtManager" packages/` returns no matches
5. `grep -q "new IckbUdt" packages/sdk/src/constants.ts` -- SDK constructs IckbUdt
6. `grep -q "IckbUdt.typeScriptFrom" packages/sdk/src/constants.ts` -- SDK uses typeScriptFrom
7. `grep -r "udtBalanceFrom" packages/` returns no matches (deprecated API eliminated)
8. `grep -r "getInputsUdtBalance\|getOutputsUdtBalance\|completeInputsByUdt" packages/` returns no matches
</verification>

<success_criteria>
- packages/utils/src/udt.ts fully deleted (~406 lines removed)
- UdtHandler, UdtManager, ErrorTransactionInsufficientCoin, UdtCell, findUdts, addUdts, isUdtSymbol no longer exist in codebase
- No deprecated CCC API calls (udtBalanceFrom, getInputsUdtBalance, etc.) remain in any package
- SDK constructs IckbUdt with individual code OutPoints (mainnet + testnet)
- SDK uses IckbUdt.typeScriptFrom to compute type script
- LogicManager and OwnedOwnerManager constructed without ickbUdt argument
- ScriptDeps, ExchangeRatio, ValueComponents preserved (not deleted)
- pnpm check:full passes across all 5 library packages
</success_criteria>

<output>
After completion, create `.planning/phases/05-ickb-core-udt-refactor/05-02-SUMMARY.md`
</output>
