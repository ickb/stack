---
phase: 01-ickb-utils-smarttransaction-removal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - forks/ccc/packages/core/src/ckb/transactionErrors.ts
  - forks/ccc/packages/core/src/ckb/transaction.ts
  - forks/ccc/packages/core/src/ckb/index.ts
  - forks/.pin/ccc/
  - packages/dao/src/dao.ts
  - packages/core/src/logic.ts
  - packages/core/src/owned_owner.ts
  - packages/utils/src/transaction.ts
autonomous: true
requirements:
  - SMTX-06

must_haves:
  truths:
    - "A single CCC utility `assertDaoOutputLimit` exists in CCC core that checks both inputs and outputs for DAO type script when outputs > 64"
    - "All 7 scattered inline DAO output checks across dao/core/utils are replaced with calls to `assertDaoOutputLimit`"
    - "The `ErrorNervosDaoOutputLimit` error class exists in CCC `transactionErrors.ts` with count and limit fields"
    - "`pnpm check:full` passes after DAO check consolidation"
  artifacts:
    - path: "forks/ccc/packages/core/src/ckb/transactionErrors.ts"
      provides: "ErrorNervosDaoOutputLimit error class"
      contains: "ErrorNervosDaoOutputLimit"
    - path: "forks/ccc/packages/core/src/ckb/transaction.ts"
      provides: "assertDaoOutputLimit utility function and completeFee safety net"
      contains: "assertDaoOutputLimit"
  key_links:
    - from: "packages/dao/src/dao.ts"
      to: "forks/ccc/packages/core/src/ckb/transaction.ts"
      via: "import and call assertDaoOutputLimit"
      pattern: "assertDaoOutputLimit"
    - from: "packages/core/src/logic.ts"
      to: "forks/ccc/packages/core/src/ckb/transaction.ts"
      via: "import and call assertDaoOutputLimit"
      pattern: "assertDaoOutputLimit"
    - from: "packages/core/src/owned_owner.ts"
      to: "forks/ccc/packages/core/src/ckb/transaction.ts"
      via: "import and call assertDaoOutputLimit"
      pattern: "assertDaoOutputLimit"
---

<objective>
Build the 64-output NervosDAO limit check as a CCC core utility and replace all 7 scattered inline checks across the iCKB packages with calls to this centralized utility.

Purpose: Consolidate duplicated DAO output limit logic into a single source of truth in CCC core, preparing for SmartTransaction deletion by removing one of its responsibilities. This is the first feature-slice step (purely additive, nothing breaks).

Output: `ErrorNervosDaoOutputLimit` error class + `assertDaoOutputLimit` utility in CCC core; all iCKB packages calling the utility instead of inline checks; forks/ccc pins recorded.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-ickb-utils-smarttransaction-removal/01-CONTEXT.md
@.planning/phases/01-ickb-utils-smarttransaction-removal/01-RESEARCH.md
@.planning/codebase/ARCHITECTURE.md

Key source files to read:
@forks/ccc/packages/core/src/ckb/transactionErrors.ts (error class patterns)
@forks/ccc/packages/core/src/ckb/transaction.ts (completeFee method, where safety net goes)
@forks/ccc/packages/core/src/ckb/index.ts (barrel exports)
@packages/utils/src/transaction.ts (SmartTransaction.completeFee with DAO check at lines 85-95)
@packages/dao/src/dao.ts (DaoManager with 3 DAO checks at lines 100, 174, 245)
@packages/core/src/logic.ts (LogicManager.deposit with DAO check at line 106)
@packages/core/src/owned_owner.ts (OwnedOwnerManager with 2 DAO checks at lines 104, 146)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build ErrorNervosDaoOutputLimit and assertDaoOutputLimit in CCC core</name>
  <files>
    forks/ccc/packages/core/src/ckb/transactionErrors.ts
    forks/ccc/packages/core/src/ckb/transaction.ts
    forks/ccc/packages/core/src/ckb/index.ts
  </files>
  <action>
**Step 1: Add error class to transactionErrors.ts**

Read `forks/ccc/packages/core/src/ckb/transactionErrors.ts`. Add `ErrorNervosDaoOutputLimit` following the existing `ErrorTransactionInsufficientCapacity` pattern:

```typescript
export class ErrorNervosDaoOutputLimit extends Error {
  public readonly count: number;
  public readonly limit: number;

  constructor(count: number) {
    super(
      `NervosDAO transaction has ${count} output cells, exceeding the limit of 64`,
    );
    this.count = count;
    this.limit = 64;
  }
}
```

**Step 2: Add assertDaoOutputLimit to transaction.ts**

Read `forks/ccc/packages/core/src/ckb/transaction.ts`. Add the standalone utility function as a module-level export (NOT a method on Transaction). Place it after the Transaction class definition. Import `ErrorNervosDaoOutputLimit` from `./transactionErrors.js`, `KnownScript` from the appropriate module, and `Script` if not already imported:

```typescript
/**
 * Asserts that a NervosDAO transaction does not exceed the 64-output limit.
 * Auto-resolves unresolved inputs (populating CellInput.cellOutput as a side effect).
 * Only checks when outputs > 64 AND at least one input or output has the DAO type script.
 *
 * @param tx - The transaction to check
 * @param client - CKB client for resolving the NervosDAO script and input cell info
 * @throws ErrorNervosDaoOutputLimit if limit exceeded
 */
export async function assertDaoOutputLimit(
  tx: Transaction,
  client: Client,
): Promise<void> {
  if (tx.outputs.length <= 64) return;

  const { codeHash, hashType } = await client.getKnownScript(
    KnownScript.NervosDao,
  );
  const dao = Script.from({ codeHash, hashType, args: "0x" });

  // Auto-resolve unresolved inputs
  for (const input of tx.inputs) {
    await input.completeExtraInfos(client);
  }

  const isDaoTx =
    tx.inputs.some((i) => i.cellOutput?.type?.eq(dao)) ||
    tx.outputs.some((o) => o.type?.eq(dao));

  if (isDaoTx) {
    throw new ErrorNervosDaoOutputLimit(tx.outputs.length);
  }
}
```

IMPORTANT: Use full `Script.eq()` comparison (codeHash + hashType + args), not just codeHash comparison.

**Step 3: Add completeFee safety net**

In the `completeFee` method of the Transaction class (around line 2183), add a call to `assertDaoOutputLimit(this, from.client)` near the end of the method, before returning. Read the method carefully to find the right insertion point -- it should be called after all outputs have been finalized but before the final return. The client is available as `from.client` (Signer has a `client` property).

**Step 4: Export from barrel**

Read `forks/ccc/packages/core/src/ckb/index.ts`. Add exports for `ErrorNervosDaoOutputLimit` (from `./transactionErrors.js`) and `assertDaoOutputLimit` (from `./transaction.js`). Follow existing export patterns in the file.

**Step 5: Record forks/ccc pins**

Run: `bash forks/forker/record.sh ccc`

This updates `forks/.pin/ccc/` to reflect the new CCC state.

Verify: `bash forks/forker/status.sh ccc` should exit 0 (no pending work).
  </action>
  <verify>
1. `bash forks/forker/status.sh ccc` exits 0
2. `grep -r "ErrorNervosDaoOutputLimit" forks/ccc/packages/core/src/ckb/transactionErrors.ts` finds the class
3. `grep -r "assertDaoOutputLimit" forks/ccc/packages/core/src/ckb/transaction.ts` finds the function
4. `pnpm check:full` passes (purely additive change, nothing should break)
  </verify>
  <done>
ErrorNervosDaoOutputLimit error class exists in CCC transactionErrors.ts with count and limit fields. assertDaoOutputLimit standalone utility exists in CCC transaction.ts using full Script.eq() comparison with args: "0x". completeFee has a safety net call to assertDaoOutputLimit. Both are exported from the CCC barrel. Pins are recorded.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace all 7 scattered DAO checks with assertDaoOutputLimit calls</name>
  <files>
    packages/dao/src/dao.ts
    packages/core/src/logic.ts
    packages/core/src/owned_owner.ts
    packages/utils/src/transaction.ts
  </files>
  <action>
Replace all 7 inline `if (tx.outputs.length > 64)` DAO checks with calls to `await assertDaoOutputLimit(tx, client)`. This requires making the containing methods async and adding a `client` parameter.

**6 sync methods that need to become async with client parameter:**

Read each file. For each method listed below:
1. Add `client: ccc.Client` parameter (add as the LAST parameter, after any existing `options` parameter -- or as a required parameter before options if options is the last param)
2. Change return type from `void` to `Promise<void>` (method becomes async)
3. Add `async` keyword to the method
4. Replace the inline check with `await assertDaoOutputLimit(tx, client);`
5. Import `assertDaoOutputLimit` from `@ckb-ccc/core` (or `ccc` namespace) at the top of each file

**packages/dao/src/dao.ts** (3 checks):
- `deposit()` at line 76 -- replace check at line 100-102 with `await assertDaoOutputLimit(tx, client);`
- `requestWithdrawal()` at line 119 -- replace check at line 174-176 with `await assertDaoOutputLimit(tx, client);`
- `withdraw()` at line 189 -- replace check at line 245-247 with `await assertDaoOutputLimit(tx, client);`

Note: `requestWithdrawal` and `withdraw` ALREADY have `client` as a parameter (they call `getHeader`). `deposit` does NOT currently have `client` -- add it.

**packages/core/src/logic.ts** (1 check):
- `deposit()` at line 68 -- replace check at line 106-108 with `await assertDaoOutputLimit(tx, client);`

Note: `deposit` does NOT currently have `client` -- add it. The method calls `this.daoManager.deposit()` which also needs client now. Since that call will need to be awaited after this change, the cascading async is intentional.

**packages/core/src/owned_owner.ts** (2 checks):
- `requestWithdrawal()` at line 69 -- replace check at line 104-106 with `await assertDaoOutputLimit(tx, client);`
- `withdraw()` at line 118 -- replace check at line 146-148 with `await assertDaoOutputLimit(tx, client);`

Note: Both methods DO NOT currently have `client` -- add it. The inner `this.daoManager.requestWithdrawal()` and `this.daoManager.withdraw()` calls already pass client (they need it for header fetching), so the `client` parameter is available up the call chain.

**packages/utils/src/transaction.ts** (1 check):
- `SmartTransaction.completeFee()` at line 63 -- replace the inline DAO check block (lines 82-95) with `await assertDaoOutputLimit(this, client);` where `client` is available as `from.client` (the Signer's client property, matching how it's done in the CCC completeFee safety net).

Note: SmartTransaction's `completeFee` is already async and already has access to client via the Signer parameter. Just replace the inline check.

**CRITICAL: Update all callers of the methods whose signatures changed.**

After adding `client` parameter to methods, search for all call sites:
- `this.daoManager.deposit(tx, ...)` in `packages/core/src/logic.ts` -- add `client` and `await`
- `this.daoManager.requestWithdrawal(tx, ...)` in `packages/core/src/owned_owner.ts` -- already passes client, but now needs `await`
- `this.daoManager.withdraw(tx, ...)` in `packages/core/src/owned_owner.ts` -- already passes client, but now needs `await`
- Any other call sites in SDK or apps -- search for `.deposit(`, `.requestWithdrawal(`, `.withdraw(` across the entire `packages/` directory

For every caller that invokes a now-async method, add `await`. If the caller itself is not async, make it async too (cascade).

Remove the old inline checks entirely (the 3-line blocks with the error string "More than 64 output cells in a NervosDAO transaction").
  </action>
  <verify>
1. `grep -r "outputs.length > 64" packages/` returns NO results (all inline checks removed)
2. `grep -r "assertDaoOutputLimit" packages/dao/src/dao.ts packages/core/src/logic.ts packages/core/src/owned_owner.ts packages/utils/src/transaction.ts` shows the utility is called in all 4 files
3. `pnpm check:full` passes -- no type errors from async/await cascading or missing client parameters
  </verify>
  <done>
All 7 inline DAO output checks are removed. Every location now calls `await assertDaoOutputLimit(tx, client)`. All affected methods are async with the client parameter. All callers updated to await the now-async methods. `pnpm check:full` passes.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "outputs.length > 64" packages/` -- should return 0 results
2. `grep -rn "assertDaoOutputLimit" packages/ forks/ccc/packages/core/src/ckb/` -- should show usage in 4 iCKB files + definition in CCC
3. `grep -rn "ErrorNervosDaoOutputLimit" forks/ccc/packages/core/src/ckb/` -- should show class definition + export
4. `bash forks/forker/status.sh ccc` -- should exit 0
5. `pnpm check:full` -- should pass clean
</verification>

<success_criteria>
- ErrorNervosDaoOutputLimit error class exists in CCC core with count/limit metadata
- assertDaoOutputLimit utility exists in CCC core using full Script.eq() comparison
- completeFee has DAO safety net
- All 7 scattered inline checks replaced with centralized utility calls
- No intermediate broken build state
- forks/ccc pins recorded
</success_criteria>

<output>
After completion, create `.planning/phases/01-ickb-utils-smarttransaction-removal/01-01-SUMMARY.md`
</output>
