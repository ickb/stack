---
phase: 01-ickb-utils-smarttransaction-removal
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - packages/utils/src/utils.ts
  - packages/dao/src/cells.ts
  - packages/dao/src/dao.ts
  - packages/core/src/cells.ts
  - packages/core/src/udt.ts
  - packages/core/src/logic.ts
  - packages/sdk/src/sdk.ts
autonomous: true
requirements:
  - SMTX-04

must_haves:
  truths:
    - "The standalone `getHeader()` function and `HeaderKey` type no longer exist in `@ickb/utils`"
    - "All 5 standalone `getHeader()` call sites inline CCC client calls (`client.getTransactionWithHeader()` or `client.getHeaderByNumber()`) with null checks"
    - "All 2 `tx.getHeader()` instance method call sites in `core/src/udt.ts` inline CCC client calls"
    - "All 3 `tx.addHeaders()` call sites push to `tx.headerDeps` directly with dedup logic"
    - "The `TransactionHeader` type is preserved in a surviving file for DaoCell and ReceiptCell to import"
    - "`pnpm check:full` passes after getHeader removal"
  artifacts:
    - path: "packages/utils/src/utils.ts"
      provides: "Utility functions WITHOUT getHeader/HeaderKey; WITH TransactionHeader type"
      contains: "TransactionHeader"
    - path: "packages/dao/src/cells.ts"
      provides: "DaoCell construction with inlined CCC client calls for header fetching"
      contains: "client.getHeaderByNumber"
    - path: "packages/core/src/cells.ts"
      provides: "ReceiptCell construction with inlined CCC client calls"
      contains: "client.getTransactionWithHeader"
  key_links:
    - from: "packages/dao/src/cells.ts"
      to: "CCC Client API"
      via: "client.getTransactionWithHeader and client.getHeaderByNumber"
      pattern: "client\\.get(TransactionWithHeader|HeaderByNumber)"
    - from: "packages/core/src/udt.ts"
      to: "CCC Client API"
      via: "client.getTransactionWithHeader for header resolution"
      pattern: "client\\.getTransactionWithHeader"
    - from: "packages/dao/src/dao.ts"
      to: "tx.headerDeps"
      via: "direct push with dedup replacing addHeaders"
      pattern: "headerDeps\\.push"
---

<objective>
Remove the `getHeader()` function and `HeaderKey` type from `@ickb/utils`, inline CCC client calls at all 9+ call sites, replace `addHeaders()` with direct `tx.headerDeps` push, and preserve the `TransactionHeader` type for downstream consumers.

Purpose: Eliminate SmartTransaction's header management infrastructure. CCC's built-in `ClientCacheMemory` LRU handles header caching transparently. This is Step 3 of the feature-slice execution order.

Output: `getHeader`/`HeaderKey` deleted from utils.ts; all call sites use CCC client directly; `TransactionHeader` type moved to utils.ts; `addHeaders` replaced with headerDeps push.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-ickb-utils-smarttransaction-removal/01-CONTEXT.md
@.planning/phases/01-ickb-utils-smarttransaction-removal/01-RESEARCH.md
@.planning/phases/01-ickb-utils-smarttransaction-removal/01-01-SUMMARY.md

Key source files to read:
@packages/utils/src/utils.ts (getHeader function and HeaderKey type to remove)
@packages/utils/src/transaction.ts (TransactionHeader type at line 506-517 to move; addHeaders instance method; getHeader instance method)
@packages/dao/src/cells.ts (3 standalone getHeader call sites at lines 91, 97, 109)
@packages/dao/src/dao.ts (2 addHeaders call sites at lines 160, 216)
@packages/core/src/cells.ts (1 standalone getHeader call site at line 84)
@packages/core/src/udt.ts (2 tx.getHeader instance method call sites at lines 108, 125)
@packages/core/src/logic.ts (1 addHeaders call site at line 125)
@packages/sdk/src/sdk.ts (1 standalone getHeader call site at line 388)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move TransactionHeader type and inline all getHeader/addHeaders call sites</name>
  <files>
    packages/utils/src/utils.ts
    packages/utils/src/transaction.ts
    packages/dao/src/cells.ts
    packages/dao/src/dao.ts
    packages/core/src/cells.ts
    packages/core/src/udt.ts
    packages/core/src/logic.ts
    packages/sdk/src/sdk.ts
  </files>
  <action>
**Step 1: Move TransactionHeader type to utils.ts**

Read `packages/utils/src/transaction.ts`. Find the `TransactionHeader` interface (around line 506-517). It looks approximately like:
```typescript
interface TransactionHeader {
  header: ccc.ClientBlockHeader;
  txHash?: ccc.Hex;
}
```

Read `packages/utils/src/utils.ts`. Add the `TransactionHeader` interface definition there (export it). This type is needed by `@ickb/dao` (DaoCell.headers) and `@ickb/core` (ReceiptCell.header).

Also ensure `TransactionHeader` is exported from `packages/utils/src/index.ts` (it may already be re-exported from `transaction.ts` -- it will need to come from `utils.ts` after transaction.ts is deleted in Plan 03).

**Step 2: Inline standalone getHeader() call sites (5 sites)**

For each call site, replace `getHeader(client, { type, value })` with direct CCC client calls. Always include null check + throw.

**packages/dao/src/cells.ts line 91** (number lookup):
```typescript
// Before:
const header = await getHeader(client, { type: "number", value: mol.Uint64LE.decode(cell.outputData) });
// After:
const header = await client.getHeaderByNumber(mol.Uint64LE.decode(cell.outputData));
if (!header) {
  throw new Error("Header not found for block number");
}
```

**packages/dao/src/cells.ts line 97** (txHash lookup):
```typescript
// Before:
const header = await getHeader(client, { type: "txHash", value: txHash });
// After:
const txWithHeader = await client.getTransactionWithHeader(txHash);
if (!txWithHeader?.header) {
  throw new Error("Header not found for txHash");
}
const header = txWithHeader.header;
```

**packages/dao/src/cells.ts line 109** (txHash lookup):
Same pattern as line 97.

**packages/core/src/cells.ts line 84** (txHash lookup):
Same pattern as above. Read the actual code to see the exact variable names and context.

**packages/sdk/src/sdk.ts line 388** (txHash lookup):
Same pattern. Read the actual code to determine what `txHash` variable is used (likely `c.cell.outPoint.txHash`).

Remove the `import { getHeader }` from each file after all call sites are updated.

**Step 3: Inline tx.getHeader() instance method call sites (2 sites in core/src/udt.ts)**

Read `packages/core/src/udt.ts`. At lines 108 and 125, `tx.getHeader()` is called (SmartTransaction instance method). Replace with CCC client calls:

```typescript
// Before:
const header = await tx.getHeader(client, { type: "txHash", value: outPoint.txHash });
// After:
const txWithHeader = await client.getTransactionWithHeader(outPoint.txHash);
if (!txWithHeader?.header) {
  throw new Error("Header not found for txHash");
}
const header = txWithHeader.header;
```

These methods already have `client` as a parameter, so no signature change is needed.

**Step 4: Replace addHeaders() call sites (3 sites) with direct headerDeps push**

Read each file. Replace `tx.addHeaders(...)` with direct push to `tx.headerDeps` with dedup.

**packages/dao/src/dao.ts line 160** (single TransactionHeader):
```typescript
// Before:
tx.addHeaders(depositHeader);
// After:
const hash = depositHeader.header.hash;
if (!tx.headerDeps.some((h) => h === hash)) {
  tx.headerDeps.push(hash);
}
```

**packages/dao/src/dao.ts line 216** (array of headers from DaoCell):
```typescript
// Before:
tx.addHeaders(...withdrawalRequests.flatMap(d => d.headers));
// OR similar pattern
// After:
for (const wr of withdrawalRequests) {
  for (const th of wr.headers) {
    const hash = th.header.hash;
    if (!tx.headerDeps.some((h) => h === hash)) {
      tx.headerDeps.push(hash);
    }
  }
}
```
Read the actual code carefully to determine the exact structure of the addHeaders call.

**packages/core/src/logic.ts line 125** (receipt headers):
```typescript
// Before:
tx.addHeaders(...receipts.map(r => r.header));
// OR similar
// After:
for (const r of receipts) {
  const hash = r.header.header.hash;
  if (!tx.headerDeps.some((h) => h === hash)) {
    tx.headerDeps.push(hash);
  }
}
```
Read the actual code to see the exact shape.

**Step 5: Remove getHeader function and HeaderKey type from utils.ts**

Read `packages/utils/src/utils.ts`. Find and delete the `getHeader` function definition and the `HeaderKey` type definition. Remove any imports that were only used by `getHeader`.

Also update `packages/utils/src/index.ts` to remove any re-export of `getHeader` or `HeaderKey` if they are exported there.

**Step 6: Update imports across all modified files**

- Remove `getHeader` and `HeaderKey` imports from all consumer files
- Add `TransactionHeader` import from `@ickb/utils` (the new location) in files that previously imported it from `transaction.ts` or `@ickb/utils` (it should already resolve correctly if the barrel export is set up)
- Ensure no circular imports are created

**IMPORTANT NOTES:**
- Do NOT delete `transaction.ts` in this plan -- that happens in Plan 03
- Do NOT change method signatures from SmartTransaction to TransactionLike -- that happens in Plan 03
- The `addHeaders` and `getHeader` instance methods on SmartTransaction class itself will be cleaned up when the class is deleted in Plan 03
- Preserve exact error semantics: the original `getHeader` threw on null results; the inlined code must also throw
  </action>
  <verify>
1. `grep -rn "getHeader" packages/utils/src/utils.ts` -- should NOT find the function definition or HeaderKey type
2. `grep -rn "from.*getHeader\|getHeader(" packages/dao/ packages/core/ packages/sdk/` -- should NOT find standalone getHeader calls (instance method calls on SmartTransaction may still exist in transaction.ts itself, which is fine -- deleted in Plan 03)
3. `grep -rn "addHeaders" packages/dao/ packages/core/` -- should NOT find any addHeaders calls
4. `grep -rn "headerDeps.push" packages/dao/ packages/core/` -- should find the new direct push calls
5. `grep -rn "TransactionHeader" packages/utils/src/utils.ts` -- should find the type definition
6. `pnpm check:full` passes
  </verify>
  <done>
`getHeader()` function and `HeaderKey` type are deleted from `@ickb/utils`. All 5 standalone `getHeader()` call sites use direct CCC client calls with null checks. All 2 `tx.getHeader()` instance method call sites in core/udt.ts use CCC client calls. All 3 `addHeaders()` call sites push to `tx.headerDeps` directly with dedup. `TransactionHeader` type is preserved in utils.ts and exported. `pnpm check:full` passes.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "getHeader\b" packages/utils/src/utils.ts` -- no function definition
2. `grep -rn "HeaderKey" packages/` -- no results (type fully removed)
3. `grep -rn "addHeaders" packages/dao/ packages/core/` -- no results
4. `grep -rn "client\.getTransactionWithHeader\|client\.getHeaderByNumber" packages/dao/ packages/core/ packages/sdk/` -- shows inlined calls
5. `grep -rn "headerDeps\.push" packages/dao/ packages/core/` -- shows direct push with dedup
6. `grep -rn "TransactionHeader" packages/utils/src/utils.ts` -- type preserved
7. `pnpm check:full` -- passes clean
</verification>

<success_criteria>
- getHeader() function deleted from @ickb/utils
- HeaderKey type deleted from @ickb/utils
- TransactionHeader type preserved and accessible from @ickb/utils
- All standalone getHeader call sites inline CCC client calls with proper null checks
- All tx.getHeader instance method call sites in core/udt.ts inline CCC client calls
- All addHeaders call sites push to tx.headerDeps with dedup
- CCC ClientCacheMemory handles header caching (no custom cache)
- Build stays green
</success_criteria>

<output>
After completion, create `.planning/phases/01-ickb-utils-smarttransaction-removal/01-02-SUMMARY.md`
</output>
