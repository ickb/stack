---
phase: 01-ickb-utils-smarttransaction-removal
plan: 03
type: execute
wave: 3
depends_on:
  - "01-02"
files_modified:
  - packages/utils/src/transaction.ts
  - packages/utils/src/capacity.ts
  - packages/utils/src/udt.ts
  - packages/utils/src/index.ts
  - packages/dao/src/dao.ts
  - packages/core/src/logic.ts
  - packages/core/src/owned_owner.ts
  - packages/core/src/udt.ts
  - packages/order/src/order.ts
  - packages/sdk/src/sdk.ts
  - packages/sdk/src/constants.ts
autonomous: true
requirements:
  - SMTX-01
  - SMTX-02

must_haves:
  truths:
    - "SmartTransaction class no longer exists in `@ickb/utils` source or exports"
    - "CapacityManager class no longer exists in `@ickb/utils` source or exports"
    - "All manager method signatures across ALL 5 library packages accept `ccc.TransactionLike` instead of `SmartTransaction`"
    - "All updated methods return `ccc.Transaction` (not void) following CCC convention"
    - "Each method converts TransactionLike to Transaction internally with `ccc.Transaction.from(txLike)`"
    - "UdtHandler interface and UdtManager class remain with updated signatures"
    - "All `addUdtHandlers()` calls are replaced with `tx.addCellDeps(this.udtHandler.cellDeps)`"
    - "`transaction.ts` and `capacity.ts` files are deleted from @ickb/utils"
    - "`pnpm check:full` passes after full removal"
  artifacts:
    - path: "packages/utils/src/udt.ts"
      provides: "UdtHandler interface and UdtManager class with TransactionLike signatures"
      contains: "TransactionLike"
    - path: "packages/utils/src/index.ts"
      provides: "Barrel exports WITHOUT transaction.ts or capacity.ts"
  key_links:
    - from: "packages/dao/src/dao.ts"
      to: "ccc.Transaction.from()"
      via: "TransactionLike input conversion at method entry"
      pattern: "Transaction\\.from\\(txLike\\)"
    - from: "packages/order/src/order.ts"
      to: "ccc.Transaction.from()"
      via: "TransactionLike input conversion at method entry"
      pattern: "Transaction\\.from\\(txLike\\)"
    - from: "packages/sdk/src/sdk.ts"
      to: "CCC client.findCellsOnChain"
      via: "CapacityManager replacement"
      pattern: "findCellsOnChain"
---

<objective>
Delete SmartTransaction class and CapacityManager class from `@ickb/utils`; update all manager method signatures across all 5 library packages from `SmartTransaction` to `ccc.TransactionLike`; replace `addUdtHandlers()` calls; update SDK to use CCC native cell finding.

Purpose: Complete the SmartTransaction removal by deleting the class and its infrastructure after all dependencies have been resolved (DAO checks consolidated in Plan 01, header management inlined in Plan 02). This is Steps 4-5 of the feature-slice execution order.

Output: `transaction.ts` and `capacity.ts` deleted; all method signatures accept `ccc.TransactionLike` and return `ccc.Transaction`; SDK uses CCC native cell finding; barrel exports cleaned.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-ickb-utils-smarttransaction-removal/01-CONTEXT.md
@.planning/phases/01-ickb-utils-smarttransaction-removal/01-RESEARCH.md
@.planning/phases/01-ickb-utils-smarttransaction-removal/01-01-SUMMARY.md
@.planning/phases/01-ickb-utils-smarttransaction-removal/01-02-SUMMARY.md

Key source files to read:
@packages/utils/src/transaction.ts (SmartTransaction class -- TO DELETE)
@packages/utils/src/capacity.ts (CapacityManager class -- TO DELETE)
@packages/utils/src/udt.ts (UdtHandler/UdtManager -- update signatures, keep)
@packages/utils/src/index.ts (barrel exports -- remove transaction.ts and capacity.ts)
@packages/dao/src/dao.ts (DaoManager methods -- update signatures)
@packages/core/src/logic.ts (LogicManager methods -- update signatures)
@packages/core/src/owned_owner.ts (OwnedOwnerManager methods -- update signatures)
@packages/core/src/udt.ts (IckbUdtManager -- update signatures)
@packages/order/src/order.ts (OrderManager methods -- update signatures)
@packages/sdk/src/sdk.ts (IckbSdk methods -- update signatures, replace CapacityManager)
@packages/sdk/src/constants.ts (getConfig -- remove CapacityManager)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update all method signatures to TransactionLike and replace addUdtHandlers</name>
  <files>
    packages/utils/src/udt.ts
    packages/dao/src/dao.ts
    packages/core/src/logic.ts
    packages/core/src/owned_owner.ts
    packages/core/src/udt.ts
    packages/order/src/order.ts
    packages/sdk/src/sdk.ts
  </files>
  <action>
For every method across all 5 library packages that currently accepts `SmartTransaction`, apply the CCC convention:
1. Change parameter type from `SmartTransaction` (or `tx: SmartTransaction`) to `txLike: ccc.TransactionLike`
2. Add `const tx = ccc.Transaction.from(txLike);` as the FIRST line of the method body
3. Change return type from `void` to `ccc.Transaction` (for sync methods) or from `Promise<void>` to `Promise<ccc.Transaction>` (for async methods, made async in Plan 01)
4. Add `return tx;` at the end of each method body
5. Replace `import { SmartTransaction }` with appropriate CCC imports (`ccc.TransactionLike`, `ccc.Transaction`)

**packages/utils/src/udt.ts** -- UdtHandler interface + UdtManager class:
Read the file. Update ALL method signatures that accept `SmartTransaction`:
- `UdtHandler` interface methods (if any accept SmartTransaction)
- `UdtManager` methods: look for methods like `getInputsUdtBalance`, `getOutputsUdtBalance`, `addUdtChange`, etc.
- For `UdtManager` methods that mutate a transaction: accept `txLike: ccc.TransactionLike`, convert with `Transaction.from()`, return `ccc.Transaction`
- **Replace `addUdtHandlers` call in UdtManager** (line ~282): replace `tx.addUdtHandlers(this)` with `tx.addCellDeps(this.cellDeps)`. The handler registration was SmartTransaction-specific; only the cellDeps part survives.

**packages/dao/src/dao.ts** -- DaoManager:
- `deposit(tx: SmartTransaction, ...)` -> `deposit(txLike: ccc.TransactionLike, ...): Promise<ccc.Transaction>` (already made async in Plan 01)
- `requestWithdrawal(tx: SmartTransaction, ...)` -> `requestWithdrawal(txLike: ccc.TransactionLike, ...): Promise<ccc.Transaction>`
- `withdraw(tx: SmartTransaction, ...)` -> `withdraw(txLike: ccc.TransactionLike, ...): Promise<ccc.Transaction>`
- Remove `SmartTransaction` import. Add `ccc.TransactionLike` and `ccc.Transaction` imports.

**packages/core/src/logic.ts** -- LogicManager:
- `deposit(tx: SmartTransaction, ...)` -> `deposit(txLike: ccc.TransactionLike, ...): Promise<ccc.Transaction>`
- `completeDeposit(tx: SmartTransaction, ...)` -> `completeDeposit(txLike: ccc.TransactionLike, ...): ccc.Transaction` (or Promise if made async)
- Inner calls to `this.daoManager.deposit(tx, ...)` must pass `tx` (the converted Transaction, NOT txLike) and capture the return: `tx = await this.daoManager.deposit(tx, ...);`
- **Replace `addUdtHandlers` calls** (lines ~87, ~123): replace `tx.addUdtHandlers(this.udtHandler)` with `tx.addCellDeps(this.udtHandler.cellDeps)`

**packages/core/src/owned_owner.ts** -- OwnedOwnerManager:
- `requestWithdrawal(tx: SmartTransaction, ...)` -> `requestWithdrawal(txLike: ccc.TransactionLike, ...): Promise<ccc.Transaction>`
- `withdraw(tx: SmartTransaction, ...)` -> `withdraw(txLike: ccc.TransactionLike, ...): Promise<ccc.Transaction>`
- Inner calls to `this.daoManager.*` must capture returned tx
- **Replace `addUdtHandlers` calls** (lines ~88, ~135): replace `tx.addUdtHandlers(this.udtHandler)` with `tx.addCellDeps(this.udtHandler.cellDeps)`

**packages/core/src/udt.ts** -- IckbUdtManager:
- `getInputsUdtBalance(client, tx: SmartTransaction)` -> `getInputsUdtBalance(client, txLike: ccc.TransactionLike): Promise<...>`
- Any other methods accepting SmartTransaction
- Convert with `Transaction.from()` at entry

**packages/order/src/order.ts** -- OrderManager:
- `mint(tx: SmartTransaction, ...)` -> `mint(txLike: ccc.TransactionLike, ...): ccc.Transaction`
- `addMatch(tx: SmartTransaction, ...)` -> `addMatch(txLike: ccc.TransactionLike, ...): ccc.Transaction` (or similar name)
- `melt(tx: SmartTransaction, ...)` -> `melt(txLike: ccc.TransactionLike, ...): ccc.Transaction`
- All other methods accepting SmartTransaction
- **Replace `addUdtHandlers` calls** (lines ~191, ~228, ~516): replace with `tx.addCellDeps(this.udtHandler.cellDeps)`

**packages/sdk/src/sdk.ts** -- IckbSdk:
- `request(tx: SmartTransaction, ...)` -> `request(txLike: ccc.TransactionLike, ...): ccc.Transaction`
- `collect(tx: SmartTransaction, ...)` -> `collect(txLike: ccc.TransactionLike, ...): ccc.Transaction`
- Any other methods accepting SmartTransaction
- Inner calls to manager methods must capture returned tx

**CRITICAL PATTERN for cascading returns:**

When a method calls another method that now returns `ccc.Transaction`:
```typescript
// Before (void return, mutating tx in-place):
this.daoManager.deposit(tx, capacities, this.script);

// After (Transaction return, must capture):
tx = await this.daoManager.deposit(tx, capacities, this.script, client);
```

The `Transaction.from()` at the callee entry point creates a new Transaction. The callee mutates and returns it. The caller must use the returned value for subsequent operations.

**addUdtHandlers replacement analysis:**

Per RESEARCH.md, all 8 `addUdtHandlers` call sites have a preceding `tx.addCellDeps(this.cellDeps)` call. The `addUdtHandlers` internally does: (1) register handler in `udtHandlers` Map (SmartTransaction-specific, lost), (2) call `addCellDeps(udtHandler.cellDeps)`. Replace each `tx.addUdtHandlers(this.udtHandler)` with `tx.addCellDeps(this.udtHandler.cellDeps)`. CCC's `addCellDeps` deduplicates, so this is safe even though `this.cellDeps` was just added on the preceding line.
  </action>
  <verify>
1. `grep -rn "SmartTransaction" packages/dao/ packages/core/ packages/order/ packages/sdk/ packages/utils/src/udt.ts` -- should return NO results (no SmartTransaction type references)
2. `grep -rn "addUdtHandlers" packages/` -- should return NO results
3. `grep -rn "TransactionLike" packages/dao/ packages/core/ packages/order/ packages/sdk/ packages/utils/src/udt.ts` -- should show TransactionLike in method signatures
4. `grep -rn "Transaction\.from(txLike)" packages/` -- should show conversion at method entry points
5. `pnpm check:full` passes (SmartTransaction class still exists at this point, but nobody imports it)
  </verify>
  <done>
All manager method signatures across all 5 library packages accept `ccc.TransactionLike` and return `ccc.Transaction`. Each method converts with `Transaction.from(txLike)` at entry. All 8 `addUdtHandlers()` calls replaced with `tx.addCellDeps(this.udtHandler.cellDeps)`. No file imports SmartTransaction. UdtHandler/UdtManager preserved with updated signatures.
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete SmartTransaction and CapacityManager, clean exports, update SDK</name>
  <files>
    packages/utils/src/transaction.ts
    packages/utils/src/capacity.ts
    packages/utils/src/index.ts
    packages/sdk/src/sdk.ts
    packages/sdk/src/constants.ts
  </files>
  <action>
**Step 1: Replace CapacityManager usage in SDK**

Read `packages/sdk/src/sdk.ts`. Find the `findCapacities` usage (around line 376). The current pattern is:
```typescript
for await (const c of this.capacity.findCapacities(client, this.bots, opts)) {
  // ...
}
```

Replace with CCC's native cell finding. Per RESEARCH.md:
```typescript
for (const lock of unique(this.bots)) {
  for await (const cell of client.findCellsOnChain(
    {
      script: lock,
      scriptType: "lock",
      filter: {
        scriptLenRange: [0n, 1n],
      },
      scriptSearchMode: "exact",
      withData: true,
    },
    "asc",
    400,
  )) {
    if (cell.cellOutput.type !== undefined || !cell.cellOutput.lock.eq(lock)) {
      continue;
    }
    // ... rest of existing logic
  }
}
```

Read the existing code carefully to understand exactly what `findCapacities` does and replicate the filtering behavior. The key filter is: cells with no type script (plain CKB capacity cells), matching the lock script exactly.

Also read `packages/sdk/src/constants.ts`. Find the `CapacityManager` usage (likely `CapacityManager.withAnyData()` in `getConfig`). Remove:
1. The `CapacityManager` import
2. The `CapacityManager.withAnyData()` call or instantiation
3. The `capacity` field from the return type (if it's part of a config object)

Update `IckbSdk` constructor or `from()` factory to no longer accept/store a `CapacityManager` instance. Remove the `this.capacity` field.

**Step 2: Delete transaction.ts**

Delete the file: `packages/utils/src/transaction.ts`

This file contains SmartTransaction class (~517 lines). After Plan 01 (DAO checks removed from completeFee) and Plan 02 (getHeader/addHeaders/TransactionHeader moved), and Task 1 of this plan (all consumers updated), nothing should import from this file.

IMPORTANT: Verify that `TransactionHeader` was already moved to `utils.ts` in Plan 02. If not, ensure it's moved before deletion.

**Step 3: Delete capacity.ts**

Delete the file: `packages/utils/src/capacity.ts`

This file contains CapacityManager class (~221 lines). After Step 1 replaced SDK usage, nothing should import from this file.

**Step 4: Clean barrel exports in index.ts**

Read `packages/utils/src/index.ts`. Remove:
- `export * from "./transaction.js";` (or similar barrel export for transaction.ts)
- `export * from "./capacity.js";` (or similar barrel export for capacity.ts)

Keep:
- `export * from "./utils.js";` (has TransactionHeader now)
- `export * from "./udt.js";` (UdtHandler/UdtManager with updated signatures)
- `export * from "./codec.js";`
- `export * from "./heap.js";`

**Step 5: Remove all SmartTransaction imports from remaining files**

Search the entire `packages/` and `apps/` directories for any remaining `SmartTransaction` imports or references:
```
grep -rn "SmartTransaction" packages/ apps/
```

If any remain (e.g., in `apps/faucet/src/main.ts` which uses SmartTransaction), update those too:
- Replace `new SmartTransaction()` with `ccc.Transaction.default()` or `new ccc.Transaction()`
- Replace `SmartTransaction.from(...)` with `ccc.Transaction.from(...)`
- Update any `completeFeeChangeToLock` calls to use `ccc.Transaction.completeFeeChangeToLock()`
- Remove `SmartTransaction` imports

**Step 6: Final build verification**

Run `pnpm check:full` to verify the entire build is green. This validates:
- No broken imports (transaction.ts and capacity.ts deleted cleanly)
- No type errors from signature changes
- All packages compile under strict TypeScript settings

**Clean delete rules from CONTEXT.md:**
- No deprecation stubs, no migration comments, no breadcrumbs
- File deletions + barrel export removal in the same commit (atomic)
  </action>
  <verify>
1. `ls packages/utils/src/transaction.ts 2>/dev/null` -- file should NOT exist
2. `ls packages/utils/src/capacity.ts 2>/dev/null` -- file should NOT exist
3. `grep -rn "SmartTransaction" packages/ apps/` -- should return NO results
4. `grep -rn "CapacityManager" packages/ apps/` -- should return NO results
5. `grep -rn "transaction\.js\|capacity\.js" packages/utils/src/index.ts` -- should NOT find these exports
6. `grep -rn "findCellsOnChain" packages/sdk/src/sdk.ts` -- should show CCC native cell finding
7. `pnpm check:full` passes
  </verify>
  <done>
`transaction.ts` and `capacity.ts` are deleted from `@ickb/utils`. Barrel exports cleaned. SmartTransaction class and CapacityManager class no longer exist anywhere. SDK uses CCC `client.findCellsOnChain()` for cell finding. No SmartTransaction or CapacityManager references remain in the codebase. `pnpm check:full` passes.
  </done>
</task>

</tasks>

<verification>
1. `ls packages/utils/src/transaction.ts packages/utils/src/capacity.ts 2>&1` -- both files gone
2. `grep -rn "SmartTransaction\|CapacityManager" packages/ apps/` -- zero results
3. `grep -rn "addUdtHandlers" packages/` -- zero results
4. `grep -rn "TransactionLike" packages/dao/ packages/core/ packages/order/ packages/sdk/ packages/utils/src/udt.ts` -- shows new signatures
5. `grep -rn "Transaction\.from(txLike)" packages/` -- shows CCC conversion pattern
6. `grep -rn "export.*from.*transaction\|export.*from.*capacity" packages/utils/src/index.ts` -- no exports from deleted files
7. `pnpm check:full` -- passes clean with all 5 library packages compiling
</verification>

<success_criteria>
- SmartTransaction class deleted from @ickb/utils (transaction.ts gone)
- CapacityManager class deleted from @ickb/utils (capacity.ts gone)
- All manager method signatures accept ccc.TransactionLike, return ccc.Transaction
- UdtHandler/UdtManager preserved with updated signatures (deferred to Phase 3+)
- All addUdtHandlers calls replaced with addCellDeps
- SDK uses CCC native cell finding instead of CapacityManager
- Barrel exports clean (no references to deleted files)
- No SmartTransaction or CapacityManager references anywhere in codebase
- pnpm check:full passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-ickb-utils-smarttransaction-removal/01-03-SUMMARY.md`
</output>
