---
phase: 03-ccc-udt-integration-investigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/03-ccc-udt-integration-investigation/03-01-INVESTIGATION.md
autonomous: true
requirements:
  - UDT-01
  - UDT-02

must_haves:
  truths:
    - "Every CCC Udt method chain (getInputsInfo -> infoFrom, getOutputsInfo -> infoFrom, completeInputsByBalance -> getInputsInfo/getOutputsInfo) is traced with exact line references showing how cells flow"
    - "The outPoint presence/absence mechanism for distinguishing input vs output cells in infoFrom is verified with concrete code evidence from CCC source"
    - "The async infoFrom override with header fetches is confirmed compatible with CCC's completion loop"
    - "All open questions from 03-RESEARCH.md (filter mismatch, capacityFree on CellAny, PR #328 compatibility, conservation law enforcement) are answered with code evidence"
    - "The IckbUdtManager -> IckbUdt migration path is mapped: constructor parameters, method signature changes, return type differences (UdtInfo vs [FixedPoint, FixedPoint])"
  artifacts:
    - path: ".planning/phases/03-ccc-udt-integration-investigation/03-01-INVESTIGATION.md"
      provides: "Detailed source code trace findings with exact line references and code snippets"
      contains: "## CCC Udt Method Chain Trace"
  key_links:
    - from: "forks/ccc/packages/udt/src/udt/index.ts"
      to: "packages/core/src/udt.ts"
      via: "infoFrom override replacing getInputsUdtBalance"
      pattern: "infoFrom.*CellAnyLike"
---

<objective>
Trace CCC Udt class internals end-to-end against actual source code and verify the feasibility of the `IckbUdt extends udt.Udt` approach identified in 03-RESEARCH.md. Resolve all open questions.

Purpose: Provide verified, source-code-backed evidence for the decision document (Plan 02). The research identified `infoFrom` as the optimal override point -- this plan validates that finding by tracing real method chains and checking edge cases.

Output: `03-01-INVESTIGATION.md` -- structured findings with exact line references, code snippets, and answers to each open question.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ccc-udt-integration-investigation/03-CONTEXT.md
@.planning/phases/03-ccc-udt-integration-investigation/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Trace CCC Udt internals and verify override feasibility</name>
  <files>.planning/phases/03-ccc-udt-integration-investigation/03-01-INVESTIGATION.md</files>
  <action>
Read and trace the following CCC source files end-to-end to verify research findings:

1. **Udt class and infoFrom** (`forks/ccc/packages/udt/src/udt/index.ts`):
   - Trace `infoFrom()` signature, return type, how it accumulates `UdtInfo`
   - Trace `getInputsInfo()` -- how it resolves `CellInput` to `Cell` via `input.getCell(client)`, confirm output `Cell` objects have `outPoint` set
   - Trace `getOutputsInfo()` -- how it iterates `tx.outputCells`, confirm yielded `CellAny` objects lack `outPoint`
   - Trace `completeInputsByBalance()` -- full chain through `getInputsInfo`/`getOutputsInfo`/`infoFrom`, how balance deficit drives completion
   - Check `Udt` constructor -- what `filter` is set to, confirm it only matches xUDT cells
   - Check `isUdt()` method -- how it differs from the current `UdtManager.isUdt()` in `@ickb/utils`
   - Check `Udt.balanceFromUnsafe()` -- how it reads UDT balance from output data

2. **CellAny and Cell types** (`forks/ccc/packages/core/src/ckb/transaction.ts`):
   - Verify `CellAny.outPoint` is `OutPoint | undefined` (not nullable)
   - Verify `CellAny` vs `Cell` -- confirm `CellAny` has `capacityFree` getter (pre-resolved: transaction.ts:404-405)
   - Check `Cell.capacityFree` -- exact computation (capacity - occupiedSize)
   - Check `CellInput.getCell(client)` -- confirm returned Cell has outPoint set
   - Check `tx.outputCells` getter -- confirm yielded values are `CellAny` without outPoint

3. **UdtInfo type** (`forks/ccc/packages/udt/src/udt/index.ts` or related):
   - Trace `UdtInfo` fields: balance, capacity, count
   - Trace `UdtInfo.addAssign()` method
   - Compare with current `IckbUdtManager.getInputsUdtBalance()` return type `[FixedPoint, FixedPoint]` -- map the migration

4. **Header access** (`forks/ccc/packages/core/src/client/client.ts`):
   - Verify `client.getTransactionWithHeader(txHash)` returns `{ transaction, header? }` where header has `.dao.ar`
   - Confirm CCC Client.cache handles repeated calls transparently

5. **PR #328 compatibility check** (`forks/ccc/packages/core/src/signer/feePayer/`):
   - Check whether PR #328's FeePayer changes affect `infoFrom` or `getInputsInfo`/`getOutputsInfo` method signatures
   - Confirm `infoFrom` override is compatible with both current and PR #328 architectures

6. **Current IckbUdtManager analysis** (`packages/core/src/udt.ts`, `packages/utils/src/udt.ts`):
   - Map each line of `IckbUdtManager.getInputsUdtBalance()` to the equivalent `infoFrom` override logic
   - Identify the `UdtManager.isUdt()` check -- verify compatibility with CCC `Udt.isUdt()`
   - Note: current `getInputsUdtBalance` iterates `tx.inputs` with `completeExtraInfos` -- CCC `getInputsInfo` uses `input.getCell(client)` instead. Verify these are equivalent.
   - Identify what `getOutputsUdtBalance()` does for iCKB -- it only counts xUDT output cells (no receipt/deposit outputs carry iCKB value), so the base `infoFrom` logic for outputs should work unchanged

Write findings as `03-01-INVESTIGATION.md` with these sections:
- **## CCC Udt Method Chain Trace** -- with exact file:line references and key code snippets
- **## CellAny vs Cell: outPoint and capacityFree** -- verified behavior with evidence
- **## UdtInfo Migration Mapping** -- how [FixedPoint, FixedPoint] maps to UdtInfo
- **## Header Access Verification** -- confirmed API and caching
- **## PR #328 Compatibility** -- confirmed or flagged
- **## Open Questions Resolved** -- answers to each open question from 03-RESEARCH.md with code evidence
- **## IckbUdtManager -> IckbUdt Override Mapping** -- line-by-line mapping of current logic to infoFrom override
- **## Edge Cases and Risks** -- any issues discovered during trace
  </action>
  <verify>
    <automated>test -f .planning/phases/03-ccc-udt-integration-investigation/03-01-INVESTIGATION.md && grep -q "## CCC Udt Method Chain Trace" .planning/phases/03-ccc-udt-integration-investigation/03-01-INVESTIGATION.md && grep -q "## Open Questions Resolved" .planning/phases/03-ccc-udt-integration-investigation/03-01-INVESTIGATION.md && grep -q "## IckbUdtManager -> IckbUdt Override Mapping" .planning/phases/03-ccc-udt-integration-investigation/03-01-INVESTIGATION.md && echo "PASS"</automated>
    <manual>Verify investigation references actual CCC source line numbers and includes code snippets for each finding</manual>
  </verify>
  <done>
    - Every CCC Udt method chain is traced with file:line references
    - outPoint presence/absence mechanism verified with CellAny/Cell source evidence
    - capacityFree availability on CellAny answered definitively
    - UdtInfo fields mapped to current [FixedPoint, FixedPoint] return type
    - PR #328 compatibility confirmed or risks flagged
    - All 4 open questions from 03-RESEARCH.md answered with code evidence
    - Line-by-line mapping from IckbUdtManager.getInputsUdtBalance to infoFrom override exists
  </done>
</task>

</tasks>

<verification>
- `03-01-INVESTIGATION.md` exists with all required sections
- Each finding includes a source file path and line number reference
- All open questions from 03-RESEARCH.md are addressed
- The IckbUdtManager -> IckbUdt mapping is complete (no unmapped logic)
</verification>

<success_criteria>
The investigation document provides sufficient verified evidence for Plan 02 to write a confident decision document. Every claim from 03-RESEARCH.md is either confirmed or corrected with source code evidence.
</success_criteria>

<output>
After completion, create `.planning/phases/03-ccc-udt-integration-investigation/03-01-SUMMARY.md`
</output>
