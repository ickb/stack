---
phase: 03-ccc-udt-integration-investigation
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - .planning/phases/03-ccc-udt-integration-investigation/03-DECISION.md
autonomous: true
requirements:
  - UDT-01
  - UDT-02
  - UDT-03

must_haves:
  truths:
    - "A feasibility assessment exists answering whether IckbUdt extends udt.Udt can override infoFrom to account for receipt cells and deposit cells alongside xUDT cells"
    - "The header access pattern for receipt/deposit value calculation is designed with specific API calls and async flow documented"
    - "A clear decision is documented with one of three outcomes (subclass, custom, hybrid) and rationale for the chosen path"
    - "The conservation law preservation strategy is documented (how sign conventions and cell type handling maintain Input UDT + Input Receipts = Output UDT + Input Deposits)"
    - "The cell discovery vs balance calculation boundary is defined (what infoFrom handles vs what callers handle)"
    - "The decision document provides sufficient detail for Phase 4 and Phase 5 implementers to proceed without ambiguity"
  artifacts:
    - path: ".planning/phases/03-ccc-udt-integration-investigation/03-DECISION.md"
      provides: "Formal decision document covering UDT-01 (feasibility), UDT-02 (header pattern), UDT-03 (decision)"
      contains: "## Decision"
  key_links:
    - from: ".planning/phases/03-ccc-udt-integration-investigation/03-DECISION.md"
      to: ".planning/ROADMAP.md"
      via: "Decision outcome determines Phase 4 and Phase 5 approach"
      pattern: "Phase [45]"
---

<objective>
Write the formal decision document synthesizing the investigation findings into actionable outcomes for UDT-01, UDT-02, and UDT-03. This document directly determines how Phases 4 and 5 implement UDT handling.

Purpose: Close Phase 3's investigation with a clear, justified decision that eliminates ambiguity for downstream phases.

Output: `03-DECISION.md` -- the formal feasibility assessment, header access pattern design, and decision with rationale.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ccc-udt-integration-investigation/03-CONTEXT.md
@.planning/phases/03-ccc-udt-integration-investigation/03-RESEARCH.md
@.planning/phases/03-ccc-udt-integration-investigation/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write feasibility assessment and header access pattern (UDT-01, UDT-02)</name>
  <files>.planning/phases/03-ccc-udt-integration-investigation/03-DECISION.md</files>
  <action>
Using the verified findings from `03-01-INVESTIGATION.md` (via 03-01-SUMMARY.md), write the first two sections of the decision document:

**## Feasibility Assessment (UDT-01)**

Structure as a clear YES/NO/CONDITIONAL answer with supporting evidence:

1. **Override Point**: Which override point (`infoFrom` vs `getInputsInfo`/`getOutputsInfo`) and why. Reference specific findings from the investigation.

2. **Three Cell Types in infoFrom**:
   - xUDT cells: How `isUdt()` identifies them, how balance is read (reference CCC's `balanceFromUnsafe` vs current `ccc.numFromBytes` approach)
   - Receipt cells: How type script matching identifies them, how `ReceiptData.decode` + `ickbValue()` computes value, positive balance contribution
   - Deposit cells: How lock script matching + `isDeposit()` identifies them, how `ickbValue(capacityFree)` computes value, NEGATIVE balance contribution (conservation law sign convention)

3. **Input vs Output Distinction**: How outPoint presence/absence in `infoFrom` cleanly separates input cells (receipt/deposit relevant) from output cells (xUDT only). Reference CellAny investigation findings.

4. **capacityFree Resolution**: How to access unoccupied capacity for deposit cells within `infoFrom`. Use investigation findings about CellAny vs Cell.

5. **Completion Pipeline Compatibility**: Confirm that `completeInputsByBalance` chains through `infoFrom` correctly, noting the filter limitation (xUDT only) and the caller-responsibility pattern for receipt/deposit cell discovery.

6. **Blockers**: List any findings that would make subclassing unviable. If none, state "No blockers identified."

**## Header Access Pattern (UDT-02)**

Design the specific pattern:

1. **API**: `client.getTransactionWithHeader(outPoint.txHash)` -- confirmed from investigation
2. **When**: Only for input cells with outPoint (receipt cells and deposit cells)
3. **What**: Extract `header.dao.ar` for exchange rate computation via `ickbValue()`
4. **Caching**: CCC Client.cache handles repeated calls -- no application-level caching needed
5. **Async flow**: `infoFrom` is already async -- header fetches integrate naturally
6. **Performance**: Few receipt/deposit cells per transaction in practice; caching mitigates repeated fetches in completion loops

Include a code sketch showing the header fetch pattern within the infoFrom override (referencing the conceptual prototype from 03-RESEARCH.md, updated with any corrections from the investigation).
  </action>
  <verify>
    <automated>test -f .planning/phases/03-ccc-udt-integration-investigation/03-DECISION.md && grep -q "## Feasibility Assessment" .planning/phases/03-ccc-udt-integration-investigation/03-DECISION.md && grep -q "## Header Access Pattern" .planning/phases/03-ccc-udt-integration-investigation/03-DECISION.md && echo "PASS"</automated>
    <manual>Verify feasibility assessment addresses all sub-questions and header pattern is specific enough for implementation</manual>
  </verify>
  <done>
    - Feasibility assessment answers YES/NO/CONDITIONAL with evidence
    - All three cell types documented with identification and valuation logic
    - Input vs output distinction mechanism documented
    - capacityFree access resolved
    - Header access pattern fully designed with API, timing, caching, async flow
    - Code sketch provided
  </done>
</task>

<task type="auto">
  <name>Task 2: Write decision and implementation guidance (UDT-03)</name>
  <files>.planning/phases/03-ccc-udt-integration-investigation/03-DECISION.md</files>
  <action>
Append the decision and implementation guidance sections to `03-DECISION.md`:

**## Decision (UDT-03)**

State the chosen approach clearly:
- **Chosen**: One of (a) subclass CCC Udt, (b) keep custom UdtHandler interface, (c) hybrid approach
- **Rationale**: Why this approach wins, referencing feasibility assessment findings
- **What it replaces**: Current `UdtHandler` interface + `UdtManager` class in `@ickb/utils` and `IckbUdtManager` in `@ickb/core`
- **What CCC features it gains**: `completeInputsByBalance`, `UdtInfo` accumulator, CCC completion pipeline integration, future upstream improvements
- **What it loses or changes**: Any behavior differences from current implementation

Per user decisions from CONTEXT.md:
- If subclassing works, that is the preferred path (user is "leaning toward IckbUdt extends udt.Udt")
- If subclassing requires upstream CCC changes, design them generically as "composite UDT" pattern
- Dealbreaker = invasive upstream changes; if blocked, reevaluate WHY and determine minimal CCC changes

**## Conservation Law Strategy**

Document how the conservation law `Input UDT + Input Receipts = Output UDT + Input Deposits` is preserved:
- `infoFrom` reports accurate balances with correct sign conventions (deposits negative)
- Enforcement location: on-chain (iCKB Logic script) vs build-time (validation method on IckbUdt)
- Recommendation per CONTEXT.md: start with accurate balance reporting (caller responsibility), add build-time validation later if needed
- Conservation law is NOT embedded in `infoFrom` (balance calculation, not validation)

**## Cell Discovery vs Balance Calculation Boundary**

Define the clean separation:
- `infoFrom` responsibility: VALUE cells that are already in the transaction
- Caller responsibility (LogicManager, OwnedOwnerManager): FIND and ADD receipt/deposit cells to the transaction
- `completeInputsByBalance` + `filter`: only finds xUDT cells (this is correct -- receipt/deposit discovery is a separate concern)
- No override of `filter` needed -- callers pre-add special cells, `infoFrom` accurately values them

**## Implementation Guidance for Phases 4-5**

Provide actionable guidance:

Phase 4 (dao/order packages):
- Replace deprecated API calls with `udt.Udt` instance methods
- `udtBalanceFrom` -> `Udt.balanceFromUnsafe()`
- `tx.getInputsUdtBalance()` / `tx.getOutputsUdtBalance()` -> `udt.getInputsInfo()` / `udt.getOutputsInfo()`
- `tx.completeInputsByUdt()` -> `udt.completeInputsByBalance()`
- DaoManager and OrderManager receive a `udt.Udt` instance instead of `UdtHandler`

Phase 5 (core package):
- Implement `IckbUdt extends udt.Udt` with `infoFrom` override in `packages/core/src/udt.ts`
- Constructor: `code` (OutPoint for xUDT cell dep), `script` (xUDT type script), `logicScript`, `daoManager`, optional `config`
- Override `infoFrom` with three-cell-type logic
- Delete `IckbUdtManager` class from `packages/core/src/udt.ts`
- Delete `UdtHandler` interface and `UdtManager` class from `packages/utils/src/udt.ts`
- Preserve `ickbValue()`, `convert()`, `ickbExchangeRatio()` functions (used by SDK estimate scenarios)
- Update SDK to use `IckbUdt` instance

**## Upstream CCC Changes**

Document whether any upstream CCC PRs are needed:
- If `infoFrom` override works without CCC changes: state "No upstream changes required for core feasibility"
- If any issues found: describe minimal, generic changes and assess likely acceptance
- Note: PR #328 (FeePayer) is orthogonal -- `infoFrom` override is compatible with both current and FeePayer architectures

**## Risks and Mitigations**

List residual risks with mitigations:
- Filter mismatch for receipt/deposit cell discovery -> mitigation: caller-responsibility pattern
- `DaoManager.isDeposit()` requires `Cell` not `CellAny` -> mitigation: construct `Cell.from(...)` when outPoint present (capacityFree is available on CellAny directly)
- Completion loop performance with header fetches -> mitigation: CCC Client.cache + few cells per tx
- Any other risks identified in the investigation
  </action>
  <verify>
    <automated>grep -q "## Decision" .planning/phases/03-ccc-udt-integration-investigation/03-DECISION.md && grep -q "## Implementation Guidance" .planning/phases/03-ccc-udt-integration-investigation/03-DECISION.md && grep -q "## Conservation Law Strategy" .planning/phases/03-ccc-udt-integration-investigation/03-DECISION.md && grep -q "## Risks and Mitigations" .planning/phases/03-ccc-udt-integration-investigation/03-DECISION.md && echo "PASS"</automated>
    <manual>Verify decision is clear and unambiguous, implementation guidance is specific enough for Phase 4/5 executors</manual>
  </verify>
  <done>
    - Decision clearly states chosen approach with rationale
    - Conservation law strategy documented
    - Cell discovery vs balance calculation boundary defined
    - Phase 4 and Phase 5 implementation guidance is specific and actionable
    - Upstream CCC changes assessed
    - Risks listed with mitigations
    - Document is self-contained -- a reader can understand the decision without needing to read the investigation
  </done>
</task>

</tasks>

<verification>
- `03-DECISION.md` exists with all required sections (Feasibility Assessment, Header Access Pattern, Decision, Conservation Law Strategy, Cell Discovery Boundary, Implementation Guidance, Upstream Changes, Risks)
- The decision is one of the three specified outcomes (a, b, or c) with clear rationale
- Implementation guidance for Phases 4 and 5 is specific enough to plan those phases without revisiting Phase 3
- All three requirement IDs (UDT-01, UDT-02, UDT-03) have corresponding sections
</verification>

<success_criteria>
A Phase 4/5 planner can read `03-DECISION.md` and know exactly: (1) whether to subclass CCC Udt or use a custom approach, (2) how header access works in the override, (3) what classes to create/delete/modify, and (4) how the conservation law is preserved. No re-investigation needed.
</success_criteria>

<output>
After completion, create `.planning/phases/03-ccc-udt-integration-investigation/03-02-SUMMARY.md`
</output>
